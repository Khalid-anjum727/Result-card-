const studentForm = document.getElementById('student-form');
    const generateResultButton = document.getElementById('generate-result');
    const resultCard = document.getElementById('result-card');
    const marksDisplay = document.getElementById('marks-display');
    const addSubjectButton = document.getElementById('add-subject');
    const subjectsContainer = document.getElementById('subjects-container');
    const printButton = document.getElementById('print-result');
    const downloadPdfButton = document.getElementById('download-pdf');
    // Get display elements
    const schoolNameDisplay = document.getElementById('school-name-display');
    const schoolLogoDisplay = document.getElementById('school-logo-display');
    const studentPhotoDisplay = document.getElementById('student-photo-display');
    const classNameDisplay = document.getElementById('class-display');
    const studentNameDisplay = document.getElementById('student-name-display');
    const rollNumberDisplay = document.getElementById('roll-number-display');
    const totalMarksDisplay = document.getElementById('total-marks-display');
    const percentageDisplay = document.getElementById('percentage-display');
    const gradeDisplay = document.getElementById('grade-display');
    const finalFeedbackDisplay = document.getElementById('final-feedback-display');
    let subjectCount = 1;

    addSubjectButton.addEventListener('click', () => {
        subjectCount++;
        const subjectRow = document.createElement('div');
        subjectRow.className = 'subject-row mb-4';
        subjectRow.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">Subject ${subjectCount}</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Subject:</label>
                    <input type="text" name="subject[]" class="form-control shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required style="font-family: 'Jameel Noori Nastaleeq', serif; direction: rtl;">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Marks:</label>
                    <input type="number" name="marks[]" class="form-control shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
            </div>
            <button type="button" class="remove-subject bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline text-xs mt-2">Remove</button>
        `;
        subjectsContainer.appendChild(subjectRow);
        const removeButton = subjectRow.querySelector('.remove-subject');
        removeButton.addEventListener('click', () => {
            subjectRow.remove();
        });
    });

    function calculateGrade(marks) {
        if (marks >= 90) return 'A+';
        else if (marks >= 80) return 'A';
        else if (marks >= 70) return 'B';
        else if (marks >= 60) return 'C';
        else if (marks >= 50) return 'D';
        else return 'F';
    }

    function getFeedback(marks) {
        if (marks >= 90) return 'Outstanding!';
        else if (marks >= 80) return 'Excellent work!';
        else if (marks >= 70) return 'Very good.';
        else if (marks >= 60) return 'Satisfactory.';
        else if (marks >= 50) return 'Needs improvement.';
        else return 'Failed.';
    }

    generateResultButton.addEventListener('click', () => {
        const schoolName = document.getElementById('school-name').value;
        const schoolLogo = document.getElementById('school-logo').files[0];
        const studentPhoto = document.getElementById('student-photo').files[0];
        const className = document.getElementById('class').value;
        const studentName = document.getElementById('student-name').value;
        const rollNumber = document.getElementById('roll-number').value;
        const subjectInputs = document.querySelectorAll('input[name="subject[]"]');
        const marksInputs = document.querySelectorAll('input[name="marks[]"]');
        let totalMarks = 0;
        let subjects = [];
        let hasEmptyFields = false;

        if (!schoolName || !className || !studentName || !rollNumber) {
            alert('Please fill in all the student information fields.');
            hasEmptyFields = true;
            return;
        }

        subjectInputs.forEach((input, index) => {
            if (!input.value || !marksInputs[index].value) {
                alert('Please fill in all subject and mark fields.');
                hasEmptyFields = true;
                return;
            }
        });

        if (hasEmptyFields) {
            return;
        }

        marksDisplay.innerHTML = ''; // Clear previous results
        subjects = []; // Clear previous subjects
        totalMarks = 0; // Reset total marks

        subjectInputs.forEach((input, index) => {
            const subject = input.value;
            const marks = parseInt(marksInputs[index].value);
            const grade = calculateGrade(marks);
            const feedback = getFeedback(marks);
            totalMarks += marks;
            subjects.push({ subject, marks, grade, feedback });
            marksDisplay.innerHTML += `
                <tr>
                    <td class="px-5 py-5 text-sm table-data" style="font-family: 'Jameel Noori Nastaleeq', serif; direction: rtl; text-align: right;">${subject}</td>
                    <td class="px-5 py-5 text-sm table-data">${marks}</td>
                    <td class="px-5 py-5 text-sm table-data">${grade}</td>
                    <td class="px-5 py-5 text-sm table-data">${feedback}</td>
                </tr>
            `;
        });

        const percentage = (subjects.length > 0) ? (totalMarks / (subjects.length * 100)) * 100 : 0;
        const overallGrade = calculateGrade(percentage);
        const finalFeedback = getFeedback(percentage);

        schoolNameDisplay.textContent = schoolName;
        classNameDisplay.textContent = `Class: ${className}`;
        studentNameDisplay.textContent = `Student Name: ${studentName}`;
        rollNumberDisplay.textContent = `Roll Number: ${rollNumber}`;
        totalMarksDisplay.textContent = `Total Marks: ${totalMarks}`;
        percentageDisplay.textContent = `Percentage: ${percentage.toFixed(2)}%`;
        gradeDisplay.textContent = `Overall Grade: ${overallGrade}`;
        finalFeedbackDisplay.textContent = `Final Feedback: ${finalFeedback}`;

        if (schoolLogo) {
            const reader = new FileReader();
            reader.onload = (e) => {
                logoImg.src = e.target.result;
            }
            reader.readAsDataURL(schoolLogo);
            schoolLogoDisplay.style.display = 'block';
        } else {
            logoImg.src = '';
            schoolLogoDisplay.style.display = 'none';
        }

        if (studentPhoto) {
            const reader = new FileReader();
            reader.onload = (e) => {
                photoImg.src = e.target.result;
            }
            reader.readAsDataURL(studentPhoto);
            studentPhotoDisplay.style.display = 'block';
        } else {
            photoImg.src = '';
            studentPhotoDisplay.style.display = 'none';
        }

        resultCard.classList.remove('hidden');
        inputForm.classList.add('hidden');
    });

    printButton.addEventListener('click', () => {
        window.print();
    });

    downloadPdfButton.addEventListener('click', () => {
        const element = document.getElementById('result-card');
        const opt = {
            margin:       10,
            filename:     'result_card.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().from(element).set(opt).save();
    });
